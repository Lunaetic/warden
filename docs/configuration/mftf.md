## Magento Functional Testing Framework

For information what **Magento Functional Testing Framework** is - please follow to [MFTF DevDocs](https://devdocs.magento.com/mftf/docs/introduction.html).

MFTF is part of Magento 2. To run tests you need [Selenium](https://selenium.dev/) instance with [Chrome Webdriver](https://sites.google.com/a/chromium.org/chromedriver/). Warden provides Docker setup that contains Selenium Standalone with Chrome. You can enable it by adding the following to the project's `.env` file (or exporting them to environment variables prior to starting the environment):

```
WARDEN_SELENIUM=1
```

After generating MFTF configuration files (`dev/tests/acceptance/.env` generated by `vendor/bin/mftf setup:env` command), you need to provide selenium hostname:

```
SELENIUM_HOST=selenium-hub
BROWSER=chrome
```

Of note - `selenium-hub` can be unreliable, and you may have a better experience using `selenium-chrome`.

To use `selenium-chrome`:

If `.warden/warden-env.yml` doesn't exist, create it in the root of your project, and insert the following:

```
version: "3.5"
services:
  selenium-chrome:
    hostname: ${WARDEN_ENV_NAME}_selenium-chrome
    image: selenium/standalone-chrome${WARDEN_SELENIUM_DEBUG:-}:3.8.1
    extra_hosts:
      - ${TRAEFIK_SUBDOMAIN:-app}.${TRAEFIK_DOMAIN}:${TRAEFIK_ADDRESS:-0.0.0.0}
    environment:
      - START_XVFB=false
```

Afterwards, you'll need to edit the MFTF `.env` configuration file (`dev/tests/acceptance/.env`) and specify the new `SELENIUM_HOST`:

```
SELENIUM_HOST=selenium-chrome
```

After doing so, you'll need to re-run the commands: `vendor/bin/mftf build:project` and `vendor/bin/mftf generate:tests`

Some MFTF tests that test uploading images for Products (such as `AdminSimpleProductImagesTest` - runnable with: `vendor/bin/mftf run:test AdminSimpleProductImagesTest`) will fail using the default configuration, due to `nginx` not having a large enough `client_max_body_size`, or the `selenium-chrome` tab crashing because `selenium-chrome` has run out of memory.

The `client_max_body_size` issue will present itself when attempting the `bmp` upload test in `AdminSimpleProductImagesTest`; it can be remedied by increasing `nginx`'s `client_max_body_size`.

To do this, create the file `.warden/nginx/conf.d/custom.conf`, and populate it with:

```
client_max_body_size 100M;
```

Then, mount a volume to the `nginx` container by adding the following to `services:` in `.warden/warden-env.yml`:

```
  nginx:
    hostname: nginx
    volumes:
      - ./.warden/nginx/conf.d/custom.conf:/etc/nginx/conf.d/custom.conf
```

Restart the environment with `warden env up -d`.

The `selenium-chrome` crashing error can be detected by examining the logs (`warden env logs selenium-chrome`) for the following:

```
selenium-chrome_1  | 20:35:02.333 INFO - To upstream: {"using":"xpath","value":"\/\/div[contains(@class, \"loading-mask\")]"}
selenium-chrome_1  | 20:35:02.387 INFO - To downstream: {"sessionId":"0dc75d43859e0c9d7a0e113827fb477b","status":13,"value":{"message":"unknown error: session deleted because of page crash\nfrom tab crashed\n  (Session info: chrome=64.0.3282.119)\n  (Driver info: chromedriver=2.35.528139 (47ead77cb35ad2a9a83248b292151462a66cd881),platform=Linux 4.19.76-linuxkit x86_64)"}}
selenium-chrome_1  | 20:35:02.388 INFO - Found handler: org.openqa.selenium.remote.server.commandhandler.GetLogsOfType@1345b27e
selenium-chrome_1  | 20:35:02.388 INFO - /session/0dc75d43859e0c9d7a0e113827fb477b/log: Executing POST on /session/0dc75d43859e0c9d7a0e113827fb477b/log (handler: GetLogsOfType)
selenium-chrome_1  | 20:35:02.389 INFO - To upstream: {"type":"browser"}
selenium-chrome_1  | 20:35:02.392 INFO - To downstream: {"sessionId":"","status":6,"value":{"message":"no such session\n  (Driver info: chromedriver=2.35.528139 (47ead77cb35ad2a9a83248b292151462a66cd881),platform=Linux 4.19.76-linuxkit x86_64)"}}
```

To remedy, the `shm_size` for the `selenium-chrome` container needs to be increased from the default of 64M.

Edit `.warden/warden-env.yml`, and `shm_size` as shown below:

```
version: "3.5"
services:
  selenium-chrome:
    shm_size: '1gb'
    hostname: ${WARDEN_ENV_NAME}_selenium-chrome
    image: selenium/standalone-chrome${WARDEN_SELENIUM_DEBUG:-}:3.8.1
    extra_hosts:
      - ${TRAEFIK_SUBDOMAIN:-app}.${TRAEFIK_DOMAIN}:${TRAEFIK_ADDRESS:-0.0.0.0}
    environment:
      - START_XVFB=false
```

Restart the environment with `warden env up -d`.

### Running Tests

We provide complex instruction on [How to run MFTF Tests](magento2-testing.html#running-mftf-tests) in Warden environment.

### Debugging MFTF Tests

By default Warden uses headless Chrome browser. If you want to preview the tests - you need to extend `.env` file and update environment containers (`warden env up -d`)

```
WARDEN_SELENIUM_DEBUG=1
```

**Default password for VNC session is `secret`**

To preview the process of testing, you need any **VLC** client that provides **SSH Tunnel** support (eg. [Remmina](https://remmina.org/how-to-install-remmina/)). To preview the process of testing, you need to use `tunnel.warden.test:2222` (login: `user`):

### Remote Desktop Viewer

  ![Remote Desktop Viewer](screenshots/selenium-remote-desktop-viewer.png) 

### Remmina

  ![Remmina Configuration](screenshots/remmina-ssh-tunnel.png)
  
### Mac OS X

To preview the process in Mac OS X, you must first create an SSH tunnel to the docker instance hosting the VNC server.  That would look something like:

    ssh -N -L localhost:5901:magento2_selenium-chrome_1:5900 tunnel.warden.test
    
Where `5901` is the port on your local computer you want to use to access the VNC server.  Then, using Finder you can "Go > Connect to Server" `vnc://localhost:5901`.
